# Bellagio OpenMAX IL 架构与核心功能概览

> 版本：libomxil-bellagio 0.9.3  
> 位置：`libomxil-bellagio-0.9.3/`

## 概览

Bellagio 提供 OpenMAX IL（Integration Layer）核心实现，面向多媒体组件（编码/解码/滤波/源/汇等）的通用接口。通过“组件装载器”抽象适配具体组件库，统一管理组件生命周期、端口与缓冲区流转，并提供内容管道与资源管理的基础设施。

- 核心入口与生命周期：`src/omxcore.c`
- 组件装载器（静态/动态）：`src/st_static_component_loader.c`、`src/dynamic_loader/ste_dynamic_component_loader.c`
- 装载器发现/注册：`src/omx_create_loaders_linux.c`
- 基础组件框架（Base）：`src/base/*`
- 内容管道（Content Pipe）：`src/content_pipe_file.*`、`src/content_pipe_inet.*`
- 参考资源管理：`src/omx_reference_resource_manager.*`
- 注册工具与公共工具：`src/omxregister.c`、`src/common.c`

## 目录结构（关键）

- `include/`：OpenMAX IL 标准头（`OMX_Core.h`、`OMX_Component.h` 等）
- `src/`：核心代码（见上）
- `test/`：测试组件与示例
- `doc/`：文档与 man 页面模板

## 核心 API（`include/OMX_Core.h`）

- `OMX_Init()`：初始化核心（发现并初始化装载器）
- `OMX_Deinit()`：反初始化核心（释放装载器与状态）
- `OMX_GetHandle(pHandle, cComponentName, pAppData, pCallbacks)`：按名称创建组件实例
- `OMX_FreeHandle(hComponent)`：释放组件实例

错误约定：
- 未找到组件：`OMX_ErrorComponentNotFound`
- 资源不足：`OMX_ErrorInsufficientResources`（在 `OMX_GetHandle()` 中需要透传该错误以满足一致性测试）

## 生命周期与入口（`src/omxcore.c`）

- `OMX_Init()`：设置初始化标志；调用 `createComponentLoaders()` 注册装载器（默认至少静态装载器）；再调用每个装载器的 `BOSA_InitComponentLoader`。
- `OMX_GetHandle()`：遍历装载器列表，调用其 `BOSA_CreateComponent` 创建组件；若任何装载器返回 `OMX_ErrorNone` 即成功；若返回 `OMX_ErrorInsufficientResources` 则直接返回该错误；否则最终返回 `OMX_ErrorComponentNotFound`。
- `OMX_Deinit()`：依次调用 `BOSA_DeInitComponentLoader` 并释放装载器列表与全局状态。

## 装载器抽象与实现

- 抽象接口：`BOSA_COMPONENTLOADER`（`src/component_loader.h`）统一定义初始化/创建/销毁/枚举等方法，以及 `loaderPrivate` 状态。
- 静态装载器：`src/st_static_component_loader.c`
  - 读取 `$HOME/.omxregister`（路径由 `componentsRegistryGetFilename()` 决定，支持 `OMX_BELLAGIO_REGISTRY` 覆盖）。
  - 对注册文件的每个库 `dlopen`，调用导出 `omx_component_library_Setup` 获取组件模板；名称匹配后创建组件并返回。
  - 销毁走组件 `ComponentDeInit` 并释放句柄。
- 动态装载器：`src/dynamic_loader/ste_dynamic_component_loader.c`
  - 扫描 `OMX_COMPONENT_PATH` 指定的插件目录，直接枚举 `.so` 并 `dlopen`；流程与静态装载器类似。
- 装载器发现：`src/omx_create_loaders_linux.c`
  - `createComponentLoaders()` 支持三路来源：数据目录下 `.omxloaders` 文件、`$(libdir)/omxloaders/` 目录中的自定义装载器库、默认静态装载器。
  - 自定义装载器需导出 `setup_component_loader(BOSA_COMPONENTLOADER* loader)`。

## 基础组件层（`src/base/*`）

为具体组件提供统一的“骨架”与通用行为：
- 生命周期与命令：`omx_base_component_SendCommand`、`omx_base_component_ComponentDeInit`、`omx_base_component_GetState` 等。
- 端口封装：音频/视频/图像/时钟端口（`omx_base_*_port.*`）。
- 类型角色：源（`omx_base_source.*`）、汇（`omx_base_sink.*`）、滤波（`omx_base_filter.*`）。
- Buffer 管理与线程：如 `omx_base_source_BufferMgmtFunction`，配合信号量/队列进行数据流转。

## 内容管道（`src/content_pipe_*`）

统一 I/O 抽象 `CP_PIPETYPE`：
- 文件管道：`file://` URI 的 `Open/Read/Write/Close`（`open/read/write/close`）。
- 网络管道：`inet://host:port` 的 `Open/Read/Write/Close`（`socket/connect/read/write`）。
- 提供标准方法指针集，部分方法为占位返回。

## 参考资源管理（`src/omx_reference_resource_manager.*`）

轻量的全局资源协调：
- 组件注册列表（时间戳、组优先级）与等待队列。
- 基本 API：`RM_Init/Deinit`、`RM_getResource`、`RM_releaseResource`、`RM_waitForResource` 等。
- 主要用于示例与最小化协调。

## 组件注册工具（`src/omxregister.c`）

生成静态装载器使用的 `.omxregister`：
- 扫描指定目录或 `BELLAGIO_SEARCH_PATH` 环境变量；对每个库 `dlopen` 并调用 `omx_component_library_Setup` 收集组件与角色；写入 `$HOME/.omxregister`。
- 参数：`-v`（详细输出）、`-l`（仅列出现有注册）、`-h`（帮助）。
- 路径解析与目录创建由 `src/common.c` 提供。

## 典型流程

1. `OMX_Init()` → 创建并初始化装载器（静态/动态）。
2. `OMX_GetHandle("OMX.Vendor.Component")` → 匹配模板并构造组件，设置回调。
3. 组件配置与端口连接 → 交互 `SetParameter/SendCommand`，进行 Buffer 流转。
4. `OMX_FreeHandle()` → 调用 `ComponentDeInit` 清理与释放。
5. `OMX_Deinit()` → 装载器反初始化与全局释放。

## 调试与注意事项

- 未注册导致静态装载器无法加载：使用 `omxregister-bellagio` 生成 `.omxregister`。
- 平台差异：使用 `dlopen`、POSIX I/O 与 sockets，Windows 需兼容层或交叉编译。
- `OMX_GetHandle()` 内的资源不足处理需保持“直接返回”以满足一致性测试（见 `omxcore.c`）。

## 扩展与定制

- 自定义装载器：提供共享库并导出 `setup_component_loader`，将库路径写入 `.omxloaders` 或部署到 `$(libdir)/omxloaders/`。
- 新组件库：导出 `omx_component_library_Setup` 以填充组件模板列表（名称、角色、构造/析构等），用 `omxregister` 写入注册表。

## 构建与运行（简要）

- 依赖：`pthread`、`dl`、POSIX sockets/I/O；自动工具链（`configure`、`make`）。
- 步骤：
  - `./configure` → `make` 安装库与工具。
  - 运行 `omxregister-bellagio` 生成组件注册表。
  - 应用层按典型流程调用 `OMX_Init` → `OMX_GetHandle` → 组件交互 → `OMX_FreeHandle` → `OMX_Deinit`。